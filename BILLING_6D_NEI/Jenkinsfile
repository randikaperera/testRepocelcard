pipeline {
    agent any 
    options {
        ansiColor('xterm')
    }
    environment {
        MAVEN_OPTS = '-Djansi.force=true'
    }
    stages {
        stage('Build') { 
            steps {
		        sh 'curl -u admin:password http://172.16.101.15:8081/artifactory/wso2-keystore/QA/wso2carbon.jks -o wso2carbon.jks'
		        sh './gradlew buildWSO2 --stacktrace'
            }
        }
		/*stage('Deploy') {
            steps {
                script {
                    esb_server_url = "https://172.16.100.24:9443"
                    esb_server_username = "admin"
                    esb_server_password = "E!@QA"
                    wso2carbon_username = "wso2carbon"
                    wso2carbon_password = "wso2carbon"
                }
                sh './gradlew deployRemote'
            }
        }*/
        stage('Test') { 
            steps {
                //sh 'newman run ./test/collection/collection.json -e ./test/collection/Dev_environment.json --insecure'
				sh './gradlew testWSO2'
            }
        }     
		
		stage('Echo') {
		steps{
        withCredentials([string(credentialsId: 'jenkins', variable: 'password1')]) {
            echo "'${password1}'!"
        }
		}
		}

        stage('Deploy snapshot') { 
            steps {
                withCredentials([steps.usernamePassword(
      credentialsId: 'ARTIFACTORY',
      usernameVariable: 'USERNAME',
      passwordVariable: 'PASSWORD')]) {
                    echo 'USERNAME : '+ USERNAME
                    echo 'PASSWORD: '+ PASSWORD
                    sh './gradlew deploySnapshot'
                }
            }
        }

        /*stage('Deploy release') {
            input{
                    message "Press Ok to continue"
                    submitter "mitrai"
                    parameters {
                    string(name:'username', defaultValue: 'user', description: 'Username of the user pressing Ok')
                }
            } 
            steps {
                withCredentials([steps.usernamePassword(
      credentialsId: 'ARTIFACTORY',
      usernameVariable: 'USERNAME',
      passwordVariable: 'PASSWORD')]) {
                    
                    sh './gradlew releaseToProduction'
                }
            }
        }*/
       
    }
}
